name: Daily Data Sync & Purge

on:
  schedule:
    - cron: '0 3 * * *' # Her gece 03:00 (UTC)
  workflow_dispatch: # Elle tetiklemek i√ßin

jobs:
  update-and-purge:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Yazma izni ≈üart
    
    steps:
    - name: Depoyu √áek
      uses: actions/checkout@v3

    - name: Node.js Kur
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: K√ºt√ºphaneleri Y√ºkle
      run: npm install

    # --- BOTLAR BURADA ---
    - name: üìÖ Akademik Takvim G√ºncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node calendar_scraper.js

    - name: üìù Sƒ±nav Programƒ± G√ºncelle (10 Saniye Modu)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node scraper.js
      timeout-minutes: 360 # 6 Saat sƒ±nƒ±r (rahat rahat √ßalƒ±≈üsƒ±n)
    # ---------------------

    - name: Verileri √áek ve JSON Yap
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node sync_supabase.js

    - name: Deƒüi≈üiklikleri Kaydet
      run: |
        git config --global user.name 'Enginar Bot'
        git config --global user.email 'bot@enginar.app'
        git add .
        git diff --quiet && git diff --staged --quiet || (git commit -m "Otomatik Veri G√ºncellemesi" && git push)

    - name: üî• Cache Temizle
      run: |
        FILES=("routes.json" "stops.json" "pins.json" "polygons.json" "food_menu.json" "widgets.json" "exams.json" "academic_calendar.json")
        REPO="${{ github.repository }}"
        for file in "${FILES[@]}"; do
          curl -s -I "https://purge.jsdelivr.net/gh/$REPO/data/$file"
          curl -s -o /dev/null "https://cdn.jsdelivr.net/gh/$REPO/data/$file"
        done
        echo "‚úÖ Bitti!"
