name: Daily Data Sync & Purge

on:
  schedule:
    - cron: '0 3 * * *' # Her gece 03:00 (UTC)
  workflow_dispatch: # Elle tetiklemek iÃ§in

jobs:
  update-and-purge:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Yazma izni ÅŸart
    
    steps:
    - name: Depoyu Ã‡ek (Checkout)
      uses: actions/checkout@v3

    - name: Node.js Kur
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: KÃ¼tÃ¼phaneleri YÃ¼kle
      run: npm install

    # --- YENÄ° EKLENEN KISIM: BOTLAR ---
    - name: ðŸ“… Akademik Takvimi Tara ve GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node calendar_scraper.js

    - name: ðŸ“ SÄ±nav ProgramÄ±nÄ± Tara ve GÃ¼ncelle (Uzun SÃ¼rebilir)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node scraper.js
      timeout-minutes: 60 # SÄ±nav botu uzun sÃ¼receÄŸi iÃ§in zaman tanÄ±dÄ±k
    # -----------------------------------

    - name: Verileri Ã‡ek ve Dosyala (Supabase -> JSON)
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node sync_supabase.js

    - name: DeÄŸiÅŸiklikleri Kaydet (Commit & Push)
      run: |
        git config --global user.name 'Enginar Bot'
        git config --global user.email 'bot@enginar.app'
        git add .
        git diff --quiet && git diff --staged --quiet || (git commit -m "Otomatik Veri GÃ¼ncellemesi" && git push)

    - name: ðŸ”¥ Cache Temizle (Purge & Warm-up)
      run: |
        FILES=("routes.json" "stops.json" "pins.json" "polygons.json" "food_menu.json" "widgets.json" "exams.json" "academic_calendar.json")
        REPO="${{ github.repository }}"
        
        for file in "${FILES[@]}"; do
          echo "ðŸ§¹ Temizleniyor: $file..."
          curl -s -I "https://purge.jsdelivr.net/gh/$REPO/data/$file"
          echo "ðŸ”¥ IsÄ±tÄ±lÄ±yor: $file..."
          curl -s -o /dev/null "https://cdn.jsdelivr.net/gh/$REPO/data/$file"
        done
        echo "âœ… TÃ¼m iÅŸlemler bitti!"
