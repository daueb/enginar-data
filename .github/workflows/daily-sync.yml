name: Daily Data Sync & Purge

on:
  schedule:
    - cron: '0 3 * * *' # Her gece 03:00 (UTC) - TÃ¼rkiye saatiyle sabah 06:00
  workflow_dispatch: # Elle tetiklemek iÃ§in buton

jobs:
  update-and-purge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Depoyu Ã‡ek (Checkout)
      uses: actions/checkout@v3

    - name: Node.js Kur
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: KÃ¼tÃ¼phaneleri YÃ¼kle
      run: npm install

    - name: Supabase'den Veri Ã‡ek ve JSON Yap
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node sync_supabase.js

    - name: DeÄŸiÅŸiklikleri Kaydet (Commit & Push)
      run: |
        git config --global user.name 'Enginar Bot'
        git config --global user.email 'bot@enginar.app'
        git add .
        # EÄŸer deÄŸiÅŸiklik varsa commit at, yoksa hata verme
        git diff --quiet && git diff --staged --quiet || (git commit -m "Otomatik Veri GÃ¼ncellemesi" && git push)

    - name: ðŸ”¥ Cache Temizle ve IsÄ±t (Purge & Warm-up)
      run: |
        # Hangi dosyalar gÃ¼ncellendiyse buraya yaz
        FILES=("routes.json" "stops.json" "pins.json" "polygons.json" "food_menu.json" "widgets.json")
        
        # Senin Repo AdÄ±n (Otomatik alÄ±r)
        REPO="${{ github.repository }}"
        
        for file in "${FILES[@]}"; do
          echo "ðŸ§¹ Temizleniyor: $file..."
          curl -s -I "https://purge.jsdelivr.net/gh/$REPO/data/$file"
          
          echo "ðŸ”¥ IsÄ±tÄ±lÄ±yor: $file..."
          curl -s -o /dev/null "https://cdn.jsdelivr.net/gh/$REPO/data/$file"
        done
        echo "âœ… TÃ¼m iÅŸlemler tamamlandÄ±!"
