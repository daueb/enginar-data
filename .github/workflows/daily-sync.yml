name: Daily Data Sync & Purge

on:
  schedule:
    - cron: '0 23 * * *' # Türkiye saatiyle 02:00
  workflow_dispatch:

jobs:
  # --- 1. ADIM: BOTLARI ÇALIŞTIR (Hızlı/Paralel) ---
  run-scrapers:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        script: [
          "1_sync_classrooms.js",
          "2_sync_academics.js",
          "3_sync_courses.js",
          "4_sync_sessions.js",
          "calendar_scraper.js",
          "scraper.js"
        ]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install
      - name: Run ${{ matrix.script }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: node ${{ matrix.script }}

  # --- 2. ADIM: JSON YAP VE PUSHLA ---
  sync-json:
    needs: run-scrapers
    if: always() # Bazı botlar hata verse de JSON'ları çekmeye çalış
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install
      - name: Supabase -> JSON
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: node sync_supabase.js
      - name: Push to GitHub
        run: |
          git config --global user.name 'Enginar Bot'
          git config --global user.email 'bot@enginar.app'
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Otomatik Güncelleme: $(date +'%Y-%m-%d')" && git push)
      - name: Purge CDN
        run: |
          FILES=("pins.json" "types.json" "classes.json" "offices.json" "foods.json" "polygons.json" "widgets.json" "stops.json" "routes.json" "exams.json" "academic_calendar.json" "academics.json" "courses.json" "sessions.json" "classrooms.json")
          for file in "${FILES[@]}"; do
            curl -s -I "https://purge.jsdelivr.net/gh/${{ github.repository }}/data/$file" > /dev/null
          done