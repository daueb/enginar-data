name: Daily Data Sync & Purge

on:
  schedule:
    - cron: '0 3 * * *' # Her gece 03:00 (UTC) - TSÄ° 06:00
  workflow_dispatch: # Manuel tetikleme butonu

jobs:
  update-and-purge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Depoyu Ã‡ek
      uses: actions/checkout@v3

    - name: Node.js Kur (v20)
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: KÃ¼tÃ¼phaneleri YÃ¼kle
      run: npm install

    # --- 1. GRUP: TEMEL VERÄ°LER (SÄ±ralama Ã–nemli!) ---
    # Not: Puppeteer iÃ§in gerekli kÃ¼tÃ¼phaneler Ubuntu imajÄ±nda hazÄ±r gelir.

    - name: ğŸ›ï¸ SÄ±nÄ±f Listesini GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: node 1_sync_classrooms.js

    - name: ğŸ‘¨â€ğŸ« Akademisyen Listesini GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: node 2_sync_academics.js

    - name: ğŸ“š Ders Listesini GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: node 3_sync_courses.js

    - name: â° Ders ProgramÄ± OturumlarÄ±nÄ± EÅŸitle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      run: node 4_sync_sessions.js
      timeout-minutes: 60

    # --- 2. GRUP: DÄ°ÄER TARAYICILAR ---

    - name: ğŸ“… Akademik Takvim GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node calendar_scraper.js

    - name: ğŸ“ SÄ±nav ProgramÄ± GÃ¼ncelle
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node scraper.js
      timeout-minutes: 120 # 2 saat yeterli olacaktÄ±r

    # --- 3. GRUP: JSON Ã‡IKTILARI VE KAYIT ---

    - name: Verileri Ã‡ek ve JSON Yap
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: node sync_supabase.js

    - name: DeÄŸiÅŸiklikleri Kaydet
      run: |
        git config --global user.name 'Enginar Bot'
        git config --global user.email 'bot@enginar.app'
        git add .
        git diff --quiet && git diff --staged --quiet || (git commit -m "Otomatik Veri GÃ¼ncellemesi: $(date +'%Y-%m-%d')" && git push)

    - name: ğŸ”¥ Cache Temizle (Purge)
      run: |
        FILES=("routes.json" "stops.json" "pins.json" "polygons.json" "food_menu.json" "widgets.json" "exams.json" "academic_calendar.json" "classrooms.json" "academics.json" "courses.json")
        REPO="${{ github.repository }}"
        for file in "${FILES[@]}"; do
          curl -s -I "https://purge.jsdelivr.net/gh/$REPO/data/$file"
          curl -s -o /dev/null "https://cdn.jsdelivr.net/gh/$REPO/data/$file"
        done
        echo "âœ… TÃ¼m iÅŸlemler ve Purge bitti!"